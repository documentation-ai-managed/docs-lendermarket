openapi: 3.0.0
info:
  title: Lendermarket API - Loan Originator
  version: 1.0.0

servers:
  - url: https://api.lendermarket.com/claims/v1/lender
    description: Production Environment
  - url: https://api.lendermarket.dev/claims/v1/lender
    description: Staging Environment

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: >
        Bearer authentication of the form Bearer <token>, where token is your auth token.

  schemas:
    # --- Generic Error Object ---
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: "The selected schedule type is invalid."

    # --- Reusable Components for Form Data ---
    # Note: Nested objects in form-data are typically represented as 'object[property]'
    ScheduleItem:
      type: object
      required: [date, principalAmount, interestAmount]
      properties:
        date: { type: string, format: date }
        principalAmount: { type: string }
        interestAmount: { type: string }

  responses:
    # Standard Status Codes (Section 154)
    BadRequest: { description: "Bad request" }
    Unauthorized: { description: "Authentication failure" }
    Forbidden: { description: "Forbidden" }
    NotFound: { description: "Resource not found" }
    Conflict: { description: "Conflict" }
    ValidationError:
      description: "Validation failed"
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
    ServerError: { description: "Internal Server Error" }

paths:
  /createLoan:
    post:
      summary: Create Loan
      tags: [Loans]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [lenderLoanId, scheduleType, loanAmount, currency, interestRate, country, lenderIssueDate, clientType]
              properties:
                lenderLoanId: { type: string, description: "Unique Loan ID on lender side" }
                scheduleType: { type: string, description: "Schedule type of the loan", enum: [ANNUITY, BULLET, FULL-BULLET, REGULAR] }
                loanAmount: { type: string, description: "Total Loan Amount in specified currency" }
                currency: { type: string, enum: [EUR], description: "Current validation restricted to EUR" }
                interestRate: { type: string, description: "Annual interest rate percentage" }
                country: { type: string, description: "Loan Originator country (3 digit ISO code" }
                lenderIssueDate: { type: string, format: date, description: "Loanâ€™s actual creation date on lender side"  }
                clientType: { type: string, enum: [CONSUMER, BUSINESS_WITH_COLLATERAL, BUSINESS_WITHOUT_COLLATERAL] }
                # Nested fields for Consumer
                "consumerClient[firstName]": { type: string }
                "consumerClient[lastName]": { type: string }
                "consumerClient[gender]": { type: string, enum: [MALE, FEMALE] }
                "consumerClient[personalCode]": { type: string }
                # Nested fields for Business
                "businessClient[companyName]": { type: string }
                "businessClient[companyRegistryCode]": { type: string }
                "businessClient[representativeName]": { type: string }
                "businessClient[representativeCode]": { type: string }
                "businessClient[collateralValue]": { type: string }
                "businessClient[currency]": { type: string }
                # Schedule array
                "schedule":
                  type: array
                  items: { $ref: '#/components/schemas/ScheduleItem' }
      responses:
        '201':
          description: "Success. Returns unique UUID for the loan."
          content:
            application/json:
              example:
                data:
                  uuid: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                  lenderLoanId: "ABC-12345"
                  status: "ACTIVE"
        '422':
          description: >
            Validation Failed. Possible messages:
            - "The selected schedule type is invalid."
            - "The selected business client.currency is invalid."
            - "LenderloanId has already been taken."
            - "The loan amount must be a number/greater than 0."
            - "The interest rate must be a number/greater than 0."
            - "The selected country is invalid."
            - "The lender issue date is not a valid date."
            - "The selected consumer client.gender is invalid."
            - "The business client.collateral value must be a number."
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /createLoanExtension:
    post:
      summary: Extend Loan
      tags: [Extensions]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [loanUuid, daysToExtend]
              properties:
                loanUuid: { type: string, format: uuid }
                daysToExtend: { type: integer, minimum: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              example:
                data:
                  uuid: "5bb85f64-5717-34533-b3fc-2c963f66afa6"
                  extendedDays: 10
                  paymentDate: "2023-02-26"
        '422':
          description: "Validation failed: The days to extend must be greater than 0."

  /createLoanBuyback:
    post:
      summary: Buyback Loan
      tags: [Buybacks]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [loanUuid, reason]
              properties:
                loanUuid: { type: string, format: uuid }
                reason:
                  type: string
                  enum: [AGREEMENT_TERMINATION, AGREEMENT_PROLONGATION, AGREEMENT_AMENDMENT, EARLY_PAYMENT]
      responses:
        '202':
          description: "Accepted (queued for execution)"
          content:
            application/json:
              example:
                data:
                  uuid: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                  status: "SENDING"
                  paymentDate: "2023-02-28"
        '422':
          description: "Validation failed: The loan uuid must be a valid UUID or selected reason is invalid."

  /payment:
    post:
      summary: Create Payment
      description: >
        Payments are distributed in order: Delayed Interest, Interest, Principal. 
        You must send either 'paymentAmount' OR the specific breakdown. 
        Providing all 4 fields (paymentAmount + breakdown) will result in an error.
      tags: [Payments]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [loanUuid, currency]
              properties:
                loanUuid: { type: string, format: uuid }
                currency: { type: string, enum: [EUR] }
                paymentAmount: { type: string, description: "Total sum of principal, interest, and delayed interest" }
                principalAmount: { type: string }
                interestAmount: { type: string }
                delayedInterestAmount: { type: string }
      responses:
        '201':
          description: Payment processed successfully
        '422':
          description: "Validation failed: The loan uuid must be a valid UUID."

  /getLoan:
    get:
      summary: View Loan Details
      tags: [Loans]
      security:
        - bearerAuth: []
      parameters:
        - name: loanUuid
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Success
          content:
            application/json:
              example:
                data:
                  uuid: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                  status: "ACTIVE"
                  remainingPrincipalAmount: "1000"
                  paymentSchedule:
                    - dueDate: "2023-02-26"
                      outstandingPrincipalAmount: "0"
                      paidPrincipalAmount: "500"
        '422':
          description: "Validation failed: The loan uuid must be a valid UUID."